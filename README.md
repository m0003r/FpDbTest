Текст оригинального тестового задания: [README.txt](README.txt)

# Принятые допущения
- Никакого парсинга SQL не происходит, т.е плейсхолдеры внутри строк будут точно так же обработаны (и, возможно, вызовут ошибку). Полноценный парсер SQL — штука достаточно хитрая, и не такая быстрая, поэтому выглядит разумным конвенция «плейсхолдеры в любом месте будут обработаны», которая заставляет чуть больше думать, когда пишешь запросы, зато работать оно будет быстро  
- Экранирование работает через `mysqli::real_escape_string` (иначе зачем вообще там mysqli передаётся в запросопостроитель)
- `skip()` не разрешён как элемент массива (для `?a` и  `?#`), выбрасывается исключение
- `skip()` разрешён как единственное значение (`?#`) — кажется, никто в здравом уме так пользоваться этим не будет
- В остальном `?#` позволяет только строки
- Экранирование полей работает через `
- Касты в int и float не вызывают дополнительных проверок, т.е. туда можно передать всё что угодно 
- `skip()` между двумя экземплярами не взаимозаменяем. Если это существенно, можно сделать его `static` 

# Особенности реализации

В тесте лежат две разные реализации: более простая, с использованием `preg_split`, и более выпендрёжная, в которой на PHP реализован несложный конечный автомат. В основе они одинаковы: бьют строку на части по спец. символам, и собирают на выходе массив из готовых частей, которые объединяются с помощью `implode`.

При этом по результатам измерений оказалось, что реализация на регулярках работает _быстрее_, чем вручную выписанный (и, вроде бы, более оптимальный) конечный автомат. Вероятно, причина этого в том, что внутренняя работа со строками в PCRE быстрее, чем работа со строками в PHP.  Впрочем, это не точно. JIT не особо помогает, хотя разницу в производительности уменьшает.

**UPD:**
Добавил также реализацию в виде конечного автомата на Rust (заодно поиграл с ext-php-rs). Оказалось, что она быстрее, чем реализация на регулярках (кроме случая, где в строке нет плейсхолдеров). Но в целом это борьба за доли микросекунды чисто для развлечения.

# Запуск тестов

Для удобства тестирования всё запаковано в docker-compose (поскольку для тестов требуется живая БД; выбрана MariaDB 11). Запускать тесты так:

```bash
docker compose
docker compose run tests
# остановить БД
docker compose down
```

При этом запускаются:
- оригинальные тесты для двух реализаций
- значительно больше тестов на PHPUnit для обеих реализаций
- мутационное тестирование через Infection
- сравнение скорости через phpBench (jit включён)

В целом всё это работает достаточно быстро (порядка 1-2 µs на запрос), поэтому более простая для чтения реализация через регулярки предпочтительнее.

Результаты бенчамарка на моей машине (Ryzen 5 7530U):

```
 **** RUNNING BENCHMARKS (RegExp) **** 
+------------------+------------------------+-----+--------+-----+----------+---------+--------+
| benchmark        | subject                | set | revs   | its | mem_peak | mode    | rstdev |
+------------------+------------------------+-----+--------+-----+----------+---------+--------+
| PerformanceBench | benchNoParams          |     | 100000 | 20  | 1.515mb  | 0.198μs | ±1.77% |
| PerformanceBench | benchWithParams        |     | 100000 | 20  | 1.515mb  | 0.613μs | ±1.64% |
| PerformanceBench | benchWithCondition     |     | 100000 | 20  | 1.515mb  | 0.850μs | ±1.50% |
| PerformanceBench | benchWithSkipCondition |     | 100000 | 20  | 1.515mb  | 0.870μs | ±2.05% |
+------------------+------------------------+-----+--------+-----+----------+---------+--------+


 **** RUNNING BENCHMARKS (DFA) **** 
+------------------+------------------------+-----+--------+-----+----------------+------------------+----------------+
| benchmark        | subject                | set | revs   | its | mem_peak       | mode             | rstdev         |
+------------------+------------------------+-----+--------+-----+----------------+------------------+----------------+
| PerformanceBench | benchNoParams          |     | 100000 | 20  | 1.515mb +0.00% | 0.711μs +258.37% | ±1.33% -24.80% |
| PerformanceBench | benchWithParams        |     | 100000 | 20  | 1.515mb +0.00% | 1.057μs +72.38%  | ±1.33% -18.90% |
| PerformanceBench | benchWithCondition     |     | 100000 | 20  | 1.515mb +0.00% | 1.437μs +69.19%  | ±1.19% -20.18% |
| PerformanceBench | benchWithSkipCondition |     | 100000 | 20  | 1.515mb +0.00% | 1.493μs +71.49%  | ±1.24% -39.55% |
+------------------+------------------------+-----+--------+-----+----------------+------------------+----------------+


 **** RUNNING BENCHMARKS (Rust DFA) **** 
+------------------+------------------------+-----+--------+-----+----------------+-----------------+----------------+
| benchmark        | subject                | set | revs   | its | mem_peak       | mode            | rstdev         |
+------------------+------------------------+-----+--------+-----+----------------+-----------------+----------------+
| PerformanceBench | benchNoParams          |     | 100000 | 20  | 1.515mb +0.00% | 0.232μs +17.04% | ±2.29% +29.19% |
| PerformanceBench | benchWithParams        |     | 100000 | 20  | 1.515mb +0.00% | 0.523μs -14.69% | ±1.70% +3.64%  |
| PerformanceBench | benchWithCondition     |     | 100000 | 20  | 1.515mb +0.00% | 0.633μs -25.51% | ±2.01% +34.19% |
| PerformanceBench | benchWithSkipCondition |     | 100000 | 20  | 1.515mb +0.00% | 0.686μs -21.22% | ±1.15% -43.77% |
+------------------+------------------------+-----+--------+-----+----------------+-----------------+----------------+
```